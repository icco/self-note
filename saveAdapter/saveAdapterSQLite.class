<?
/*
#########################################

SQLite Database schema for ajaxAutoSave
CREATE TABLE notes-drafts (id INTEGER PRIMARY KEY,post TEXT, tag TEXT, ts TIMESTAMP, email TEXT);
*/

	class saveAdapter
	{
		$db = NULL;

		function saveToDatabase($text, $draft)
		{
			global $SQLITE_DB;

			if (isset($text))
			{
				if (($errorData = saveAdapter::dbConnect($SQLITE_DB)) !== true)
				{
					$error = 102;
				}
				elseif (($errorData = saveAdapter::setText(1, $text, $draft)) !== true)
				{
					$error = 103;
				}
			}
			else
			{
				$error = 101;
				$errorData = "";
			}

			if (isset($error))
			{
				// creating error node with errormessage
				echo '<error errorNumber="' . $error . '" errorData="' . saveAdapter::convertToXmlAttribute($errorData) . '" />' ;
			}
			else
			{
				// creating XML node with success message
				echo '<result message="success" />';
			}
		}


		// Connect to database
		function dbConnect($database)
		{
	  		global $dbstatus;
	  		global $db;


			if($dbStatus['Connected'])
			{
				return true;
			}
			
			try {
				$db = new PDO("sqlite:" . $SQLITE_DB);
			} catch (PDOException $e) {
				echo 'Connection failed: ' . $e->getMessage();
				return $dbStatus['Connected'] = false;
			}

			return $dbStatus['Connected'] = true;
		}


		// Set the text of a specific user
		function setText($ID, $text, $draft)
		{
				$DelQuery = "DELETE FROM notes_drafts WHERE id = '$ID'";
				$InsQuery = "INSERT INTO notes_drafts (id, post) values (1, '" . $text . "')";
				$UpQuery = "UPDATE notes_drafts SET post = '" . $text . "' WHERE id = '$ID'";
				
				if(isset($draft))
				{
					$result = db->exec($DelQuery);	
					$result = $db->exec($InsQuery);
				}

				$result = $db->exec($UpQuery);

				return $result;
		}


		// prepare string as xml attribute
		function convertToXmlAttribute($value)
		{
			return htmlspecialchars($value);
		}


		// write XML header
		function writeXmlHeader($command, $preventCaching)
		{
			if ($preventCaching)
			{
				// Prevent the browser from caching the result.
				// Date in the past
				header('Expires: Mon, 26 Jul 1997 05:00:00 GMT') ;
				// always modified
				header('Last-Modified: ' . gmdate('D, d M Y H:i:s') . ' GMT') ;
				// HTTP/1.1
				header('Cache-Control: no-store, no-cache, must-revalidate') ;
				header('Cache-Control: post-check=0, pre-check=0', false) ;
				// HTTP/1.0
				header('Pragma: no-cache') ;
			}
			// Set the response format.
			header( 'Content-Type:text/xml; charset=UTF-8' ) ;
			// Create the XML document header.
			echo '<?xml version="1.0" encoding="UTF-8"?>' ;
			// Create the main "adapter" node.
			echo '<adapter command="' . $command . '" >' ;
		}


		// write XML footer
		function writeXmlFooter()
		{
			// Close the main "adapter" node.
			echo '</adapter>' ;
		}

	}

?>
